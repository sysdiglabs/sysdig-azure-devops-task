<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.vsassets.io/v/M165_20210910.4/_scripts/TFS/min/VSS.SDK.min.js"></script>
</head>
<body>
    <div id="htmlContent">Loading...</div>

    <script>
        VSS.init({
            explicitNotifyLoaded: true,
            usePlatformScripts: true,
            usePlatformStyles: true
        });

        VSS.ready(function () {
            VSS.require(["TFS/Build/BuildRestClient"], function (_BuildClient) {
                VSS.getService(VSS.ServiceIds.Build).then(function(buildService) {
                    buildService.onBuildChanged(function(build) {
                        var buildId = build.id;
                        var projectId = VSS.getWebContext().project.id;
                        console.log(buildId, projectId);

                        var client = _BuildClient.getClient();
                        client.getPlanAttachments(projectId, "build", buildId, "htmlReport").then(function(attachments) {
                            var attachment = attachments[0]; // assuming there is one attachment with the name "htmlReport"
                            client.getAttachmentContent(projectId, "build", buildId, attachment.timelineId, attachment.recordId, attachment.type, attachment.name).then(function(content) {
                                var htmlContent = new TextDecoder('utf-8').decode(content);
                                document.getElementById("htmlContent").innerHTML = htmlContent;
                                VSS.notifyLoadSucceeded();
                            }).catch(function(err) {
                                console.error('Error fetching attachment content', err);
                                VSS.notifyLoadFailed(err);
                            });
                        }).catch(function(err) {
                            console.error('Error fetching attachments', err);
                            VSS.notifyLoadFailed(err);
                        });
                    });
                }).catch(function(err) {
                    console.error('Failed to get build service:', err);
                });
            });
        });
    </script>
</body>
</html>
